<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk" InitialTargets="Version">
  <Import Sdk="Microsoft.NET.Sdk.WindowsDesktop" Project="Sdk.props" Condition="'$(TargetFramework)' == 'netcoreapp3.1' or '$(TargetFramework)' == 'net5.0-windows'" />
  <PropertyGroup>
    <ProjectGuid>{6EE10D92-E3E4-44D9-8E6B-851801B0B510}</ProjectGuid>
    <OutputType>WinExe</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>EDDiscovery</RootNamespace>
    <AssemblyName>EDDiscovery</AssemblyName>
    <TargetFrameworks>net461</TargetFrameworks>
    <Prefer32Bit>false</Prefer32Bit>
    <NoWin32Manifest>true</NoWin32Manifest>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <EmbeddedResourceUseDependentUponConvention>true</EmbeddedResourceUseDependentUponConvention>
</PropertyGroup>
  <PropertyGroup Condition="'$(OS)' == 'Windows_NT' and '$(NETCoreSdkVersion)' != '' and '$(NETCoreSdkVersion.Substring(0, 3))' == '3.1'">
    <TargetFrameworks>net461;netcoreapp3.1</TargetFrameworks>
  </PropertyGroup>
  <PropertyGroup Condition="'$(OS)' == 'Windows_NT' and '$(NETCoreSdkVersion)' != '' and '$(NETCoreSdkVersion.Substring(0, 1))' == '5'">
    <TargetFrameworks>net461;netcoreapp3.1;net5.0-windows</TargetFrameworks>
  </PropertyGroup>
  <PropertyGroup Condition="'$(TargetFramework)' == 'netcoreapp3.1' or '$(TargetFramework)' == 'net5.0-windows'">
    <UseWPF>true</UseWPF>
    <UseWindowsForms>true</UseWindowsForms>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <PlatformTarget>AnyCPU</PlatformTarget>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup>
    <ApplicationIcon>Resources\edlogo_3mo_icon.ico</ApplicationIcon>
  </PropertyGroup>
  <ItemGroup Condition="'$(TargetFramework)' == 'netcoreapp3.1' or '$(TargetFramework)' == 'net5.0-windows'">
    <Compile Remove="UserControls\ScansStars\UserControlLocalMap.cs" />
    <Compile Remove="UserControls\ScansStars\UserControlLocalMap.Designer.cs" />
    <EmbeddedResource Remove="UserControls\ScansStars\UserControlLocalMap.resx" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="OxyPlot.Core" Version="2.0.0" />
    <PackageReference Include="OxyPlot.WindowsForms" Version="2.0.0" />
    <PackageReference Include="System.Configuration.ConfigurationManager" Version="4.6.0" />
    <PackageReference Include="System.Threading.AccessControl" Version="4.5.0" />
  </ItemGroup>
  <ItemGroup Condition="'$(TargetFramework)' == 'net461'">
    <Reference Include="PresentationCore" />
    <Reference Include="PresentationFramework" />
    <Reference Include="System.Design" />
    <Reference Include="System.Windows.Forms" />
    <Reference Include="System.Windows.Forms.DataVisualization" />
    <Reference Include="System.Xaml" />
    <Reference Include="System.Windows.Forms" />
    <Reference Include="UIAutomationProvider" />
    <Reference Include="WindowsBase" />
    <Reference Include="WindowsFormsIntegration" />
  </ItemGroup>
  <ItemGroup>
    <None Include="..\EDDIcons\Controls\Fakes\Controls.Designer.cs">
      <Link>Icons\Controls.Designer.cs</Link>
      <AutoGen>True</AutoGen>
      <DesignTime>True</DesignTime>
      <DependentUpon>Controls.resx</DependentUpon>
    </None>
    <None Include="App.Portable.config" />
    <Content Include="x86\Microsoft.VC100.CRT\msvcp100.dll" />
    <Content Include="x86\Microsoft.VC100.CRT\msvcr100.dll" />
  </ItemGroup>
  <ItemGroup>
    <None Include="..\EDDIcons\Controls\Fakes\Controls.resx">
      <Link>Icons\Controls.resx</Link>
      <Generator>PublicResXFileCodeGenerator</Generator>
      <CustomToolNamespace>EDDiscovery.Icons</CustomToolNamespace>
      <LastGenOutput>Controls.Designer.cs</LastGenOutput>
    </None>
  </ItemGroup>
  <ItemGroup Label="3DMap">
    <Compile Update="3DMap\FormMap.cs" />
  </ItemGroup>
  <ItemGroup Label="Forms">
    <Compile Update="Forms\*.cs">
      <SubType>Form</SubType>
    </Compile>
    <Compile Update="Forms\*.Designer.cs">
      <SubType>Code</SubType>
    </Compile>
    <Compile Update="Forms\VersioningManager.cs">
      <SubType>Code</SubType>
    </Compile>
  </ItemGroup>
  <ItemGroup Label="UserControls">
    <Compile Update="UserControls\*\*.cs">
      <SubType>UserControl</SubType>
    </Compile>
    <Compile Update="UserControls\*\*.Designer.cs">
      <SubType>Code</SubType>
    </Compile>
    <Compile Update="UserControls\Helpers\*.cs">
      <SubType>Code</SubType>
    </Compile>
    <Compile Update="UserControls\Helpers\FindSystemsUserControl.cs" />
    <Compile Update="UserControls\Helpers\StatsTimeUserControl.cs" />
    <Compile Update="UserControls\Helpers\ScanDisplayUserControl.cs">
      <SubType>UserControl</SubType>
    </Compile>
    <Compile Update="UserControls\Helpers\TagsForm.cs" />
    <Compile Update="UserControls\Helpers\SurfaceBookmarksUC.cs">
      <SubType>UserControl</SubType>
    </Compile>
  </ItemGroup>
  <ItemGroup Label="ScreenShots">
    <Compile Update="ScreenShots\ScreenShotConfigureForm.cs" />
  </ItemGroup>
  <ItemGroup Label="Main">
    <Compile Update="EDDiscoveryForm.cs" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\ActionLanguage\ActionLanguage.WinForms\ActionLanguage.WinForms.csproj" />
    <ProjectReference Include="..\ActionLanguage\ActionLanguage\ActionLanguage.csproj" />
    <ProjectReference Include="..\BaseUtilities\Audio\Audio.csproj" />
    <ProjectReference Include="..\BaseUtilities\BaseUtilities\BaseUtils.csproj" />
    <ProjectReference Include="..\BaseUtilities\BaseUtils.WinForms\BaseUtils.WinForms.csproj" />
    <ProjectReference Include="..\BaseUtilities\DirectInput\DirectInput.csproj" />
    <ProjectReference Include="..\BaseUtilities\OpenTKUtils\OpenTKUtils.csproj" />
    <ProjectReference Include="..\BaseUtilities\SQLLite\SQLLite.csproj" />
    <ProjectReference Include="..\EDDIcons\EDDIcons.csproj" />
    <ProjectReference Include="..\EliteDangerousCore\EliteDangerous.WinForms\EliteDangerous.WinForms.csproj" />
    <ProjectReference Include="..\EliteDangerousCore\EliteDangerous\EliteDangerous.csproj" />
    <ProjectReference Include="..\ExtendedControls\ExtendedControls\ExtendedControls.csproj" />
    <ProjectReference Include="..\ExtendedControls\ExtendedForms\ExtendedForms.csproj" />
    <ProjectReference Include="..\BaseUtilities\Audio.WindowsSpeech\Audio.WindowsSpeech.csproj" />
    <ProjectReference Include="..\BaseUtilities\Audio.CSCore\Audio.CSCore.csproj" />
  </ItemGroup>
  <ItemGroup>
    <Compile Update="Properties\Resources.Designer.cs">
      <DesignTime>True</DesignTime>
      <AutoGen>True</AutoGen>
      <DependentUpon>Resources.resx</DependentUpon>
    </Compile>
    <Compile Update="Properties\Settings.Designer.cs">
      <DesignTimeSharedInput>True</DesignTimeSharedInput>
      <AutoGen>True</AutoGen>
      <DependentUpon>Settings.settings</DependentUpon>
    </Compile>
  </ItemGroup>
  <ItemGroup>
    <EmbeddedResource Update="Properties\Resources.resx">
      <Generator>ResXFileCodeGenerator</Generator>
      <LastGenOutput>Resources.Designer.cs</LastGenOutput>
    </EmbeddedResource>
  </ItemGroup>
  <ItemGroup>
    <None Update="Properties\Settings.settings">
      <Generator>SettingsSingleFileGenerator</Generator>
      <LastGenOutput>Settings.Designer.cs</LastGenOutput>
    </None>
  </ItemGroup>
  <UsingTask TaskName="Zip" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <OutputFilename ParameterType="System.String" Required="true" />
      <BaseDirectory ParameterType="System.String" Required="true" />
      <Files ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.IO.Compression" />
      <Using Namespace="System.IO.Compression" />
      <Code Type="Fragment" Language="cs"><![CDATA[
            try
            {
                var zipnames = new HashSet<string>();
                Log.LogMessage("Zip root '" + BaseDirectory + "'", MessageImportance.High);

                using (Stream zipStream = new FileStream(Path.GetFullPath(OutputFilename), FileMode.Create, FileAccess.Write))
                {
                    using (ZipArchive archive = new ZipArchive(zipStream, ZipArchiveMode.Create))
                    {
                        foreach (ITaskItem fileItem in Files)
                        {
                            string filename = fileItem.ItemSpec;

                            if (File.Exists(filename))
                            {
                                string name = fileItem.GetMetadata("Name");
                                string metaname = name;

                                if (String.IsNullOrEmpty(name))
                                {
                                    if (filename.StartsWith(BaseDirectory))
                                    {
                                        name = filename.Substring(BaseDirectory.Length);
                                    }
                                    else
                                    {
                                        name = Path.GetFileName(filename);
                                    }
                                }

                                Log.LogMessage(".. zip up '" + filename + "' m:'" + metaname + "' -> '" + name + "'", MessageImportance.High);

                                if (!zipnames.Contains(name))
                                {
                                    using (Stream fileStream = new FileStream(filename, FileMode.Open, FileAccess.Read))
                                    {
                                        using (Stream fileStreamInZip = archive.CreateEntry(name).Open())
                                        {
                                            fileStream.CopyTo(fileStreamInZip);
                                            zipnames.Add(name);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                return true;
            }
            catch (Exception ex)
            {
                Log.LogErrorFromException(ex);
                return false;
            }
      ]]></Code>
    </Task>
  </UsingTask>
  <Target Name="DeleteExtraInterop" AfterTargets="Build" Condition=" '$(OutDir)' != '' and Exists('$(OutDir)') ">
    <ItemGroup>
      <ExtraSQLiteInterop Include="$(OutDir)SQLite.Interop.dll" />
    </ItemGroup>
    <Delete Files="@(ExtraSQLiteInterop)" Condition="Exists('$(OutDir)SQLite.Interop.dll')" />
  </Target>
  <Target Name="MakeZip" Condition=" '$(OS)' != 'Unix' and '$(OutDir)' != '' and Exists('$(TargetPath)') " AfterTargets="Build">
    <ItemGroup>
      <WebFiles Include="$(MSBuildProjectDirectory)\..\WebSite\EDD\**" />
    </ItemGroup>
    <Message Text="Webfiles zip up '@(WebFiles)'" />
    <Zip OutputFilename="$(OutDir)eddwebsite.zip" Files="@(WebFiles)" BaseDirectory="$(MSBuildProjectDirectory)\..\WebSite\EDD\" />
    <ItemGroup>
      <ZipFiles Include="$(TargetPath)" />
      <ZipFiles Include="$(OutDir)*.dll" />
      <ZipFiles Include="$(OutDir)*.pdb" />
      <ZipFiles Include="$(OutDir)eddwebsite.zip" />
      <ZipFiles Include="$(MSBuildProjectDirectory)\Translations\*.tlf" />
      <ZipFiles Include="$(MSBuildProjectDirectory)\UserControls\*.tlp" />
      <ZipFiles Include="$(MSBuildProjectDirectory)\..\EliteDangerous\EliteDangerous\*.tlp" />
      <ZipFiles Include="$(MSBuildProjectDirectory)\..\EliteDangerous\JournalEvents\*.tlp" />
      <ZipFiles Include="$(ProjectDir)App.Portable.config">
        <Name>EDDiscovery.exe.config</Name>
      </ZipFiles>
      <Zipfiles Include="$(OutDir)x64\SQLite.Interop.dll">
        <Name>x64\SQLite.Interop.dll</Name>
      </Zipfiles>
      <Zipfiles Include="$(OutDir)x86\SQLite.Interop.dll">
        <Name>x86\SQLite.Interop.dll</Name>
      </Zipfiles>
      <Zipfiles Include="$(OutDir)runtimes\**\*.dll" />
    </ItemGroup>
    <Message Text="Portable build Zip up '@(ZipFiles)' -&gt; '$(OutDir)EDDiscovery.Portable.zip'" />
    <Zip OutputFilename="$(OutDir)EDDiscovery.Portable.zip" BaseDirectory="$(OutDir)" Files="@(ZipFiles)" />
    <Error Condition="!Exists('$(OutDir)EDDiscovery.Portable.zip')" Text="Unknown error in BuildPortableZip." />
  </Target>
  <Target Name="CleanZipFile" AfterTargets="Clean">
    <PropertyGroup>
      <OutDir Condition=" '$(OutDir)' == '' ">$(OutputPath)</OutDir>
    </PropertyGroup>
    <Delete Files="$(OutDir)EDDiscovery.Portable.zip" />
    <Delete Files="$(OutDir)eddwebsite.zip" />
  </Target>
  <Target Name="Version" BeforeTargets="Build">
    <PropertyGroup Condition=" '$(OS)' != 'Unix' ">
      <GitPath>$(Registry:HKEY_LOCAL_MACHINE\SOFTWARE\GitForWindows@InstallPath)</GitPath>
      <GitPath Condition=" '$(GitPath)' == '' Or !Exists('$(GitPath)\bin\git.exe') ">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\SOFTWARE\GitForWindows', 'InstallPath', null, RegistryView.Registry64))</GitPath>
      <GitPath Condition=" '$(GitPath)' != '' ">$(GitPath)\bin\git.exe</GitPath>
      <GitPath Condition=" !Exists('$(GitPath)') ">git.exe</GitPath>
    </PropertyGroup>
    <PropertyGroup Condition=" '$(OS)' == 'Unix' ">
      <GitPath Condition=" Exists('/usr/bin/git') ">/usr/bin/git</GitPath>
      <GitPath Condition=" '$(GitPath)' == '' ">git</GitPath>
    </PropertyGroup>
    <PropertyGroup>
      <MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\..\packages\MSBuildTasks.1.5.0.235\tools</MSBuildCommunityTasksPath>
    </PropertyGroup>
    <PropertyGroup>
      <In>$([System.IO.File]::ReadAllText('$(MSBuildProjectDirectory)/Properties/AssemblyInfo.cs'))</In>
      <Pattern>^\s*\[assembly: AssemblyVersion\(\D*(\d+)\.(\d+(\.\d+)*)</Pattern>
      <AssemblyVersionMajor>$([System.Text.RegularExpressions.Regex]::Match($(In), $(Pattern), System.Text.RegularExpressions.RegexOptions.Multiline).Groups[1].Value)</AssemblyVersionMajor>
      <AssemblyVersionMinor>$([System.Text.RegularExpressions.Regex]::Match($(In), $(Pattern), System.Text.RegularExpressions.RegexOptions.Multiline).Groups[2].Value)</AssemblyVersionMinor>
    </PropertyGroup>
    <Exec Command="&quot;$(GitPath)&quot; describe --always --dirty" ConsoleToMsBuild="true" EchoOff="true" StandardOutputImportance="low" StandardErrorImportance="low" IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="GitCommitHash" />
      <Output TaskParameter="ExitCode" PropertyName="GitExitCode" />
    </Exec>
    <PropertyGroup Condition="$(GitExitCode) != 0">
      <GitCommitHash>
      </GitCommitHash>
      <GitCommitHash Condition="Exists('$(MSBuildProjectDirectory)/../.git/HEAD')">$([System.IO.File]::ReadAllText('$(MSBuildProjectDirectory)/../.git/HEAD'))</GitCommitHash>
      <Pattern>^ref: (.*)$</Pattern>
      <GitCommitRef Condition="$([System.Text.RegularExpressions.Regex]::IsMatch($(GitCommitHash), $(Pattern)))">$([System.Text.RegularExpressions.Regex]::Match($(GitCommitHash), $(Pattern)).Groups[1].Value)</GitCommitRef>
      <GitCommitHash Condition="'$(GitCommitRef)' != '' And Exists('$(MSBuildProjectDirectory)/../.git/$(GitCommitRef)')">$([System.IO.File]::ReadAllText('$(MSBuildProjectDirectory)/../.git/$(GitCommitRef)'))</GitCommitHash>
      <Pattern>^([0-9a-f]{7})[0-9a-f]*$</Pattern>
      <GitCommitHash Condition="$([System.Text.RegularExpressions.Regex]::IsMatch($(GitCommitHash), $(Pattern)))">$(GitCommitHash.SubString(0,7))</GitCommitHash>
    </PropertyGroup>
    <Message Importance="high" Text="Version: $(AssemblyVersionMajor).$(AssemblyVersionMinor), Commit: $(GitCommitHash)" />
    <ItemGroup>
      <AssemblyAttribute Include="System.Reflection.AssemblyInformationalVersionAttribute">
        <_Parameter1>$(AssemblyVersionMajor).$(AssemblyVersionMinor)+$(GitCommitHash)</_Parameter1>
      </AssemblyAttribute>
    </ItemGroup>
    <WriteCodeFragment AssemblyAttributes="@(AssemblyAttribute)" Language="C#" OutputFile="Properties\ExtraVersion.cs" />
  </Target>
  <Import Sdk="Microsoft.NET.Sdk.WindowsDesktop" Project="Sdk.targets" Condition="'$(TargetFramework)' == 'netcoreapp3.1' or '$(TargetFramework)' == 'net5.0-windows'" />
</Project>
